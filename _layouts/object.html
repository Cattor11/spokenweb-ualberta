<!DOCTYPE html>
<html lang='en-us'>
  {% include head.html %}
  <body>
    <time datetime='{{ 'now' | date: '%Y-%m-%d %H:%M' }}'></time>
    <div id='sp-fullscreen'>
      {% include header.html %}
      {% assign audio_object = site.data.objects[page.iden] %}

      <script>
          let mouse_x = 0.0;

          function format_time(seconds) {
              let hours = Math.floor(seconds / 3600).toString().padStart(2, "0");
              let minutes = Math.floor(seconds / 60).toString().padStart(2, "0");
              let new_seconds = Math.floor(seconds % 60).toString().padStart(2, "0");
              return hours + ":" + minutes + ":" + new_seconds;
          }

          function seek(time) {
              let audio = document.getElementById("sp-audio-stream");
              audio.currentTime = time;
          }

          function init() {
              let audio = document.getElementById("sp-audio-stream");
              audio.addEventListener("play", function() {document.getElementById("sp-play-button").innerHTML = '<img src="{{ '/img/play-button.svg' | absolute_url }}">';});
              audio.addEventListener("pause", function() {document.getElementById("sp-play-button").innerHTML = '<img src="{{ '/img/play-button.svg' | absolute_url }}">';});
              audio.addEventListener("timeupdate", progress);
          }

          function progress() {
              let progress = document.getElementById("sp-red-progress");
              let audio = document.getElementById("sp-audio-stream");

              document.getElementById("sp-audio-current-time").innerText = format_time(audio.currentTime);
              document.getElementById("sp-audio-duration").innerText = format_time(audio.duration);

              progress.style.width = (Math.round(audio.currentTime / audio.duration * 100).toString()) + "%";
          }

          function forward() {
              let audio = document.getElementById("sp-audio-stream");
              let timestamps = [
                {% for annotation in audio_object.annotations %}
                    {{ annotation.time }},
                {% endfor %}
              ]
              let current = audio.currentTime;
              audio.currentTime = timestamps.find(x => x > current);
          }

          function rewind() {
              let audio = document.getElementById("sp-audio-stream");
              let timestamps = [
                {% for annotation in audio_object.annotations %}
                    {{ annotation.time }},
                {% endfor %}
              ]
              let current = audio.currentTime;
              let index = timestamps.findIndex(x => x > current);
              audio.currentTime = timestamps[index - 1];
          }

          function play() {
              let audio = document.getElementById("sp-audio-stream");
              if (audio.paused) {
                  audio.play();
              } else {
                  audio.pause();
              }
          }

          function move(e) {
              mouse_x = e.clientX;
          }

          function scrub() {
              let bar = document.getElementById("scrub-bar");
              let rect = bar.getBoundingClientRect();
              let percent = (mouse_x - rect.left) / (rect.right - rect.left);
              let audio = document.getElementById("sp-audio-stream");
              audio.currentTime = audio.duration * percent;
              let progress = document.getElementById("sp-red-progress");
              progress.style.width = (Math.round(percent * 100).toString()) + "%";
          }

          document.onmousemove = move;
          window.addEventListener("DOMContentLoaded", init);


      </script>

      <div class="sp-audio-red-wrapper">
          <div class="sp-audio-red-block"></div>

          <div class="sp-audio-player">
              <div class="sp-audio-featured-image">
                  <img src="{{ audio_object.medium }}">
              </div>
              <div class="sp-audio-controls">
                  <h1>{{ audio_object.title }}</h1>
                  <div id="scrub-bar" class="sp-runtime" onclick="scrub()">
                      <div id="sp-red-progress" class="sp-red"></div>
                      <div class="sp-white"></div>
                  </div>
                  <div class="sp-time-display">
                      <span id="sp-audio-current-time">00:00:00</span> <span id="sp-audio-duration">00:00:00</span>
                  </div>
                  <div class="sp-buttons">
                      <button class="sp-back" onclick="rewind()"><img src="{{ '/img/fast-forward.svg' | absolute_url }}"></button>
                      <button class="sp-play" onclick="play()" id="sp-play-button"><img src="{{ '/img/play-button.svg' | absolute_url }}"></button>
                      <button class="sp-forward" onclick="forward()"><img src="{{ '/img/fast-forward.svg' | absolute_url }}"></button>
                  </div>
                  <audio id="sp-audio-stream" src="{{ audio_object.stream }}"></audio>
              </div>
          </div>
      </div>
      <div id='wax-main'>
        <div>
          <div class="sp-objects-content">
            <input class="sp-annotation-checkbox-input" type="checkbox" name="" id="" />
            <div class="sp-annotation-checkbox"></div>
            <div class="sp-metadata">
              <h3>About</h3>
              {% for metadata in audio_object.metadata %}
              <p><b>{{ metadata.key }}:</b><br> {{ metadata.value }}</p>
              {% endfor %}
            </div>
            {% if audio_object.annotations.size > 0 %}
            <div class="sp-divider"></div>
            <div class="sp-annotations">
              <h3>Time Stamped Sections</h3>
              {% for annotation in audio_object.annotations %}
              <div class="sp-timestamp">
                <p>{{ annotation.value }}: <a class="sp-audio-seek" onclick="seek({{ annotation.time }})">{{ annotation.formatted }}</a></p>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% include footer.html %}
    </div>
  </body>
  <script type='text/javascript' async defer src='{{ "/assets/bootstrap/bootstrap.min.js" | absolute_url }}'></script>
  <script type='text/javascript' async defer src='{{ "/assets/popper.min.js" | absolute_url }}'></script>
</html>



